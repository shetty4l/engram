name: CI

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  validate:
    uses: shetty4l/core/.github/workflows/ci-shared.yml@main
    with:
      extra-validate-command: |
        set +e
        bun run test:full 2>&1 | tee full-test.log
        code=${PIPESTATUS[0]}
        set -e

        if grep -Eq '(^|[[:space:]])[1-9][0-9]* fail([[:space:]]|$)' full-test.log; then
          echo "Full suite has one or more test failures"
          exit 1
        fi

        if [ "$code" -eq 133 ]; then
          echo "::warning::Ignoring known Bun WASM/runtime crash (exit 133) after successful full-suite assertions"
          exit 0
        fi

        exit "$code"
