name: Release

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Compute next version
        id: version
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.1.0")
          echo "latest_tag=${LATEST_TAG}" >> "$GITHUB_OUTPUT"

          # Strip 'v' prefix and split into major.minor.patch
          VERSION="${LATEST_TAG#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          NEXT_PATCH=$((PATCH + 1))
          NEXT_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}"
          echo "next_version=${NEXT_VERSION}" >> "$GITHUB_OUTPUT"
          echo "next_tag=v${NEXT_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Releasing: v${NEXT_VERSION} (previous: ${LATEST_TAG})"

      - name: Write VERSION file
        run: echo "${{ steps.version.outputs.next_version }}" > VERSION

      - name: Write BUILD_META.json
        run: |
          SHA="${{ github.event.workflow_run.head_sha }}"
          SHORT_SHA="${SHA:0:7}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          TITLE="$(git log -1 --format='%s' "$SHA")"
          BUILD_TIME="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          cat > BUILD_META.json <<ENDJSON
          {
            "gitSha": "${SHA}",
            "gitShortSha": "${SHORT_SHA}",
            "gitBranch": "${BRANCH}",
            "commitTitle": "${TITLE}",
            "buildTimeUtc": "${BUILD_TIME}"
          }
          ENDJSON

      - name: Create source tarball
        run: |
          TAG="${{ steps.version.outputs.next_tag }}"
          tar czf "engram-${TAG}.tar.gz" \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='test' \
            --exclude='.husky' \
            --exclude='.DS_Store' \
            --exclude='dist' \
            src/ \
            opencode/ \
            scripts/install.sh \
            package.json \
            bun.lock \
            tsconfig.json \
            biome.json \
            VERSION \
            BUILD_META.json

      - name: Create tag and release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.version.outputs.next_tag }}"

          git tag "${TAG}"
          git push origin "${TAG}"

          gh release create "${TAG}" \
            --title "Release ${TAG}" \
            --notes "Automated release ${TAG}" \
            "engram-${TAG}.tar.gz" \
            "scripts/install.sh"
